import{c as a,o as i,b as s,i as u,e as d,t as r,h as g,F as y,w as m,J as $,E as O,k as D,v,r as L,a as C,H,n as I,d as P}from"./app-D7NOcWij.js";import{a as G,u as T,_ as K}from"./SaleForm-BjlgKwig.js";import{P as Q}from"./Pagination-vciuAFkx.js";import{a as R,u as W}from"./ReportGenerator-DeoSEoUy.js";import{_ as X}from"./SupplierList-nuhXvO0M.js";import{a as Y}from"./ProductList-C-FCwWHx.js";import{_ as Z}from"./ProductCategoryList-CCmw_pq_.js";import{u as J,a as x}from"./useConfitmModalStore-DrikvhW_.js";import{_}from"./_plugin-vue_export-helper-DlAUqK2U.js";const tt={class:"mb-2"},et={class:"dropdown d-inline-block ms-2"},st={style:{"font-size":"12px"},class:"btn btn-outline-secondary",type:"button","data-bs-toggle":"dropdown"},lt={key:0},ot={key:1},nt={key:2},it={class:"dropdown-menu"},at={class:"modal fade",id:"saleFilterModal",tabindex:"-1"},dt={class:"modal-dialog modal-fullscreen"},rt={class:"modal-body"},ut={class:"form-floating mb-2"},mt={key:0,class:"form-check form-switch mb-2"},pt={class:"form-floating mb-2"},ft={class:"form-floating mb-2"},bt={class:"form-floating mb-2"},yt={class:"form-floating mb-2"},ct={class:"form-floating mb-2"},gt={class:"form-floating mb-2"},vt={class:"form-floating mb-2"},kt={class:"input-group mb-2"},St={class:"form-floating flex-grow-1"},ht=["value"],Ct={class:"input-group mb-2"},wt={class:"form-floating flex-grow-1"},$t=["value"],Ft={class:"input-group mb-2"},Pt={class:"form-floating flex-grow-1"},It=["value"],Dt={class:"input-group mb-2"},Tt={class:"form-floating flex-grow-1"},_t=["value"],Vt={class:"input-group mb-2"},Mt={class:"form-floating flex-grow-1"},At=["value"],Ut=["onUpdate:modelValue","id"],jt=["for"],qt={class:"form-floating mb-2"},Bt={class:"form-floating mb-3"},zt={name:"SaleFilterForm",data(){return{page:0,size:20,onlyMyTask:!1,needCompletedTask:!1,userStore:J(),salesStore:T(),tab:"filter",titleMap:{agent:"Выбор младшего админа",customer:"Выбор клиента",supplier:"Выбор поставщика"},selectedAgent:null,selectedProduct:null,selectedProductCategory:null,selectedSupplier:null,selectedCustomer:null,field_visible:[],sortableFields:{id:"№",title:"Название",description:"Описание",status:"Статус",due_date:"Дата назначения встречи",sale_date:"Дата продажи",payment_type:"Тип оплаты",actual_delivery_date:"Фактическая дата доставки",quantity:"Доставляемое число товара",total_price:"Сумма заказа",agent_id:"Администратор",customer_id:"Клиент",supplier_id:"Поставщик",created_by_id:"Создатель заявки",product_id:"Продукт"},filters:{number:"",title:"",payment_type:null,description:"",status:"",date_type:null,date_from:"",date_to:"",agent_id:"",customer_id:"",supplier_id:"",created_by_id:"",product_id:"",product_category_id:"",quantity:"",total_price:""}}},computed:{role(){var l;return((l=this.userStore.self)==null?void 0:l.role)??0}},mounted(){let l=["title","description","status","due_date","agent_id"];for(const e in this.sortableFields)this.field_visible[e]=l.indexOf(e)!==-1;this.tab="filter"},methods:{applyFilters(){const l={...this.filters,size:this.size,page:this.page,only_my_tasks:this.onlyMyTask,field_visible:this.field_visible},e=bootstrap.Modal.getInstance(document.getElementById("saleFilterModal"));e&&e.hide(),this.$emit("apply-filters",l)},cancelAgent(){this.selectedAgent=null,this.$nextTick(()=>{this.filters.agent_id=null})},selectAgent(l){this.selectedAgent=null,this.$nextTick(()=>{this.selectedAgent=l,this.filters.agent_id=(l==null?void 0:l.id)||null,this.tab="filter"})},openFilter(){new bootstrap.Modal(document.getElementById("saleFilterModal")).show()},cancelCustomer(){this.selectedCustomer=null,this.$nextTick(()=>{this.filters.customer_id=null})},selectCustomer(l){this.selectedCustomer=null,this.$nextTick(()=>{this.selectedCustomer=l,this.filters.customer_id=(l==null?void 0:l.id)||null,this.tab="filter"})},cancelProductCategory(){this.selectedProductCategory=null,this.$nextTick(()=>{this.filters.product_category_id=null})},selectProductCategory(l){console.log(l),this.selectedProductCategory=null,this.$nextTick(()=>{this.selectedProductCategory=l,this.filters.product_category_id=(l==null?void 0:l.id)||null,this.tab="filter"})},cancelProduct(){this.selectedProduct=null,this.$nextTick(()=>{this.filters.product_id=null})},selectProduct(l){this.selectedProduct=null,this.$nextTick(()=>{this.selectedProduct=l,this.filters.product_id=(l==null?void 0:l.id)||null,this.tab="filter"})},cancelSupplier(){this.selectedSupplier=null,this.$nextTick(()=>{this.filters.supplier_id=null})},selectSupplier(l){this.selectedSupplier=null,this.$nextTick(()=>{this.selectedSupplier=l,this.filters.supplier_id=(l==null?void 0:l.id)||null,this.tab="filter"})},changeSort(l){const e=this.salesStore.sort,t=e.field===l&&e.direction==="asc"?"desc":"asc";this.salesStore.setSort(l,t),this.salesStore.fetchFiltered()},clearFilters(){const l={number:"",title:"",description:"",status:"",date_type:null,date_from:"",date_to:"",agent_id:"",customer_id:"",product_id:"",product_category_id:"",supplier_id:"",created_by_id:"",quantity:"",total_price:""};this.size=20,this.page=0,this.onlyMyTask=!1;let e=["title","description","status","due_date","agent_id"];for(const t in this.sortableFields)this.field_visible[t]=e.indexOf(t)!==-1;this.filters=l}}},Et=Object.assign(zt,{setup(l){return(e,t)=>{var n,p,f,b,k;return i(),a(y,null,[s("div",tt,[s("button",{style:{"font-size":"12px"},class:"btn btn-secondary",onClick:t[0]||(t[0]=(...o)=>e.openFilter&&e.openFilter(...o))},"Фильтр "),s("div",et,[s("button",st,[u(r(e.sortableFields[e.salesStore.sort.field].slice(0,17))+" ",1),e.sortableFields[e.salesStore.sort.field].length>17?(i(),a("span",lt,"...")):d("",!0),t[46]||(t[46]=u(" (",-1)),e.salesStore.sort.direction==="asc"?(i(),a("span",ot,[...t[44]||(t[44]=[s("i",{class:"fa-solid fa-arrow-down"},null,-1)])])):d("",!0),e.salesStore.sort.direction==="desc"?(i(),a("span",nt,[...t[45]||(t[45]=[s("i",{class:"fa-solid fa-arrow-up"},null,-1)])])):d("",!0),t[47]||(t[47]=u(") ",-1))]),s("ul",it,[s("li",null,[s("a",{class:"dropdown-item",onClick:t[1]||(t[1]=o=>e.changeSort("id"))},"№")]),s("li",null,[s("a",{class:"dropdown-item",onClick:t[2]||(t[2]=o=>e.changeSort("title"))},"Название")]),s("li",null,[s("a",{class:"dropdown-item",onClick:t[3]||(t[3]=o=>e.changeSort("status"))},"Статус")]),s("li",null,[s("a",{class:"dropdown-item",onClick:t[4]||(t[4]=o=>e.changeSort("sale_date"))},"Дата продажи")]),s("li",null,[s("a",{class:"dropdown-item",onClick:t[5]||(t[5]=o=>e.changeSort("total_price"))},"Сумма")])])])]),s("div",at,[s("div",dt,[s("form",{onSubmit:t[43]||(t[43]=g((...o)=>e.applyFilters&&e.applyFilters(...o),["prevent"])),class:"modal-content"},[t[74]||(t[74]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},"Фильтры"),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",rt,[e.tab==="filter"?(i(),a(y,{key:0},[s("div",ut,[m(s("select",{"onUpdate:modelValue":t[6]||(t[6]=o=>e.filters.status=o),class:"form-select",id:"statusSelect"},[...t[48]||(t[48]=[O('<option value="">Все</option><option value="pending">В ожидании</option><option value="completed">Завершено</option><option value="delivered">Доставляется</option><option value="rejected">Отклонено</option>',5)])],512),[[$,e.filters.status]]),t[49]||(t[49]=s("label",{for:"statusSelect"},"Статус",-1))]),e.role>=3?(i(),a("div",mt,[m(s("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":t[7]||(t[7]=o=>e.onlyMyTask=o),id:"only-my-tasks"},null,512),[[D,e.onlyMyTask]]),t[50]||(t[50]=s("label",{class:"form-check-label",for:"only-my-tasks"}," Только мои сделки ",-1))])):d("",!0),s("div",pt,[m(s("input",{class:"form-control","onUpdate:modelValue":t[8]||(t[8]=o=>e.filters.number=o),id:"titleInput",placeholder:"Номер сделки"},null,512),[[v,e.filters.number]]),t[51]||(t[51]=s("label",{for:"titleInput"},"Номер сделки",-1))]),s("div",ft,[m(s("input",{class:"form-control","onUpdate:modelValue":t[9]||(t[9]=o=>e.filters.title=o),id:"titleInput",placeholder:"Название"},null,512),[[v,e.filters.title]]),t[52]||(t[52]=s("label",{for:"titleInput"},"Название",-1))]),s("div",bt,[m(s("input",{class:"form-control","onUpdate:modelValue":t[10]||(t[10]=o=>e.filters.description=o),id:"descInput",placeholder:"Описание"},null,512),[[v,e.filters.description]]),t[53]||(t[53]=s("label",{for:"descInput"},"Описание",-1))]),s("div",yt,[m(s("select",{id:"itemsPerPage",class:"form-select","onUpdate:modelValue":t[11]||(t[11]=o=>e.filters.payment_type=o)},[...t[54]||(t[54]=[s("option",{value:null},"Любой тип оплаты",-1),s("option",{value:"0"},"Наличная оплата",-1),s("option",{value:"1"},"Безналичная оплата",-1)])],512),[[$,e.filters.payment_type]]),t[55]||(t[55]=s("label",{for:"itemsPerPage"},"Тип оплаты",-1))]),s("div",ct,[m(s("select",{"onUpdate:modelValue":t[12]||(t[12]=o=>e.filters.date_type=o),class:"form-select",id:"dateTypeSelect"},[...t[56]||(t[56]=[s("option",{value:null},"Не имеет значения",-1),s("option",{value:"2"},"Дата оплаты заказа",-1),s("option",{value:"0"},"Дата создания задачи",-1),s("option",{value:"4"},"Дата доставки фактическая",-1)])],512),[[$,e.filters.date_type]]),t[57]||(t[57]=s("label",{for:"dateTypeSelect"},"Тип даты",-1))]),s("div",gt,[m(s("input",{type:"date","onUpdate:modelValue":t[13]||(t[13]=o=>e.filters.date_from=o),class:"form-control",id:"dateFromInput"},null,512),[[v,e.filters.date_from]]),t[58]||(t[58]=s("label",{for:"dateFromInput"},"Дата от",-1))]),s("div",vt,[m(s("input",{type:"date","onUpdate:modelValue":t[14]||(t[14]=o=>e.filters.date_to=o),class:"form-control",id:"dateToInput"},null,512),[[v,e.filters.date_to]]),t[59]||(t[59]=s("label",{for:"dateToInput"},"Дата до",-1))]),e.role>=3?(i(),a(y,{key:1},[s("div",kt,[s("div",St,[s("input",{type:"text",disabled:"",onChange:t[15]||(t[15]=o=>e.selectedAgent=null),value:((n=e.selectedAgent)==null?void 0:n.name)||"не указан",class:"form-control",id:"agentInput",placeholder:"Агент"},null,40,ht),t[60]||(t[60]=s("label",{for:"agentInput"},"Администратор",-1))]),e.selectedAgent?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-light text-primary",onClick:t[16]||(t[16]=(...o)=>e.cancelAgent&&e.cancelAgent(...o))},[...t[61]||(t[61]=[s("i",{class:"fa-solid fa-xmark"},null,-1)])])):d("",!0),s("button",{type:"button",class:"btn btn-outline-light text-primary",onClick:t[17]||(t[17]=o=>e.tab="agent")}," Выбрать ")]),s("div",Ct,[s("div",wt,[s("input",{class:"form-control",type:"text",disabled:"",onChange:t[18]||(t[18]=o=>e.selectedCustomer=null),value:((p=e.selectedCustomer)==null?void 0:p.name)||"не указан",id:"customerInput",placeholder:"Клиент"},null,40,$t),t[62]||(t[62]=s("label",{for:"customerInput"},"Клиент",-1))]),e.selectedCustomer?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-light text-primary",onClick:t[19]||(t[19]=(...o)=>e.cancelCustomer&&e.cancelCustomer(...o))},[...t[63]||(t[63]=[s("i",{class:"fa-solid fa-xmark"},null,-1)])])):d("",!0),s("button",{type:"button",class:"btn btn-outline-light text-primary",onClick:t[20]||(t[20]=o=>e.tab="customer")}," Выбрать ")])],64)):d("",!0),s("div",Ft,[s("div",Pt,[s("input",{class:"form-control",type:"text",disabled:"",onChange:t[21]||(t[21]=o=>e.selectedSupplier=null),value:((f=e.selectedSupplier)==null?void 0:f.name)||"не указан",id:"supplierInput",placeholder:"Поставщик"},null,40,It),t[64]||(t[64]=s("label",{for:"supplierInput"},"Поставщик",-1))]),e.selectedSupplier?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-light text-primary",onClick:t[22]||(t[22]=(...o)=>e.cancelSupplier&&e.cancelSupplier(...o))},[...t[65]||(t[65]=[s("i",{class:"fa-solid fa-xmark"},null,-1)])])):d("",!0),s("button",{type:"button",class:"btn btn-outline-light text-primary",onClick:t[23]||(t[23]=o=>e.tab="supplier")}," Выбрать ")]),s("div",Dt,[s("div",Tt,[s("input",{type:"text",disabled:"",onChange:t[24]||(t[24]=o=>e.selectedProduct=null),value:((b=e.selectedProduct)==null?void 0:b.name)||"не указан",class:"form-control",id:"agentInput",placeholder:"Агент"},null,40,_t),t[66]||(t[66]=s("label",{for:"agentInput"},"Продукт",-1))]),e.selectedProduct?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-light text-primary",onClick:t[25]||(t[25]=(...o)=>e.cancelProduct&&e.cancelProduct(...o))},[...t[67]||(t[67]=[s("i",{class:"fa-solid fa-xmark"},null,-1)])])):d("",!0),s("button",{type:"button",class:"btn btn-outline-light text-primary",onClick:t[26]||(t[26]=o=>e.tab="product")}," Выбрать ")]),s("div",Vt,[s("div",Mt,[s("input",{type:"text",disabled:"",onChange:t[27]||(t[27]=o=>e.selectedProductCategory=null),value:((k=e.selectedProductCategory)==null?void 0:k.name)||"не указана",class:"form-control",id:"agentInput",placeholder:"Агент"},null,40,At),t[68]||(t[68]=s("label",{for:"agentInput"},"Категория товара",-1))]),e.selectedProductCategory?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-light text-primary",onClick:t[28]||(t[28]=(...o)=>e.cancelProductCategory&&e.cancelProductCategory(...o))},[...t[69]||(t[69]=[s("i",{class:"fa-solid fa-xmark"},null,-1)])])):d("",!0),s("button",{type:"button",class:"btn btn-outline-light text-primary",onClick:t[29]||(t[29]=o=>e.tab="product_category")}," Выбрать ")]),e.role>=3?(i(),a(y,{key:2},[t[70]||(t[70]=s("h6",null,"Отображаемые поля",-1)),(i(!0),a(y,null,L(e.sortableFields,(o,c)=>(i(),a("div",{key:c,class:"form-check form-switch mb-2"},[m(s("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":h=>e.field_visible[c]=h,id:`switch-${c}`},null,8,Ut),[[D,e.field_visible[c]]]),s("label",{class:"form-check-label",for:`switch-${c}`},r(o),9,jt)]))),128))],64)):d("",!0),s("div",qt,[m(s("select",{id:"itemsPerPage",class:"form-select","onUpdate:modelValue":t[30]||(t[30]=o=>e.size=o)},[...t[71]||(t[71]=[O('<option value="10">10</option><option value="20">20</option><option value="50">50</option><option value="100">100</option><option value="500">500</option><option value="1000">1000</option><option value="5000">5000</option>',7)])],512),[[$,e.size]]),t[72]||(t[72]=s("label",{for:"itemsPerPage"},"Элементов на странице",-1))]),s("div",Bt,[m(s("input",{type:"number",id:"pageNumber",class:"form-control","onUpdate:modelValue":t[31]||(t[31]=o=>e.page=o),min:"0"},null,512),[[v,e.page]]),t[73]||(t[73]=s("label",{for:"pageNumber"},"Номер страницы",-1))]),s("button",{type:"button",onClick:t[32]||(t[32]=(...o)=>e.clearFilters&&e.clearFilters(...o)),class:"btn btn-outline-light text-secondary mb-2 w-100 p-3"},"Очистить фильтры ")],64)):d("",!0),e.tab==="agent"?(i(),a(y,{key:1},[s("button",{class:"btn btn-secondary my-3",onClick:t[33]||(t[33]=o=>e.tab="filter")},"Назад "),e.selectedAgent!=null?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-secondary p-3 w-100 mb-2",onClick:t[34]||(t[34]=o=>e.selectAgent(null))},"Отменить выбор ")):d("",!0),C(R,{"for-select":!0,onSelect:e.selectAgent},null,8,["onSelect"])],64)):d("",!0),e.tab==="product"?(i(),a(y,{key:2},[s("button",{class:"btn btn-secondary my-3",onClick:t[35]||(t[35]=o=>e.tab="filter")},"Назад "),e.selectedProduct!=null?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-secondary p-3 w-100 mb-2",onClick:t[36]||(t[36]=o=>e.selectProduct(null))},"Отменить выбор ")):d("",!0),C(Y,{"for-select":!0,onSelect:e.selectProduct},null,8,["onSelect"])],64)):d("",!0),e.tab==="product_category"?(i(),a(y,{key:3},[s("button",{class:"btn btn-secondary my-3",onClick:t[37]||(t[37]=o=>e.tab="filter")},"Назад "),e.selectedProductCategory!=null?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-secondary p-3 w-100 mb-2",onClick:t[38]||(t[38]=o=>e.selectProductCategory(null))},"Отменить выбор ")):d("",!0),C(Z,{"for-select":!0,onSelect:e.selectProductCategory},null,8,["onSelect"])],64)):d("",!0),e.tab==="customer"?(i(),a(y,{key:4},[s("button",{class:"btn btn-secondary my-3",onClick:t[39]||(t[39]=o=>e.tab="filter")},"Назад "),e.selectedCustomer!=null?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-secondary p-3 w-100 mb-2",onClick:t[40]||(t[40]=o=>e.selectCustomer(null))},"Отменить выбор ")):d("",!0),C(G,{"for-select":!0,onSelect:e.selectCustomer},null,8,["onSelect"])],64)):d("",!0),e.tab==="supplier"?(i(),a(y,{key:5},[s("button",{class:"btn btn-secondary my-3",onClick:t[41]||(t[41]=o=>e.tab="filter")},"Назад "),e.selectedSupplier!=null?(i(),a("button",{key:0,type:"button",class:"btn btn-outline-secondary p-3 w-100 mb-2",onClick:t[42]||(t[42]=o=>e.selectSupplier(null))},"Отменить выбор ")):d("",!0),C(X,{"for-select":!0,onSelect:e.selectSupplier},null,8,["onSelect"])],64)):d("",!0)]),t[75]||(t[75]=s("div",{class:"modal-footer"},[s("button",{type:"submit",class:"btn btn-primary w-100 p-3"},"Применить фильтры")],-1))],32)])])],64)}}}),Nt={name:"TaskCard",props:{task:{alertStore:H(),type:Object,required:!0}},data(){return{salesStore:T(),statusLabels:{pending:"В ожидании",assigned:"Назначено",delivered:"Доставлено",completed:"Завершено",rejected:"Отклонено"}}},methods:{formatDate(l){return l?new Date(l).toLocaleDateString():"—"},async sendPaymentDocumentToTg(){await this.salesStore.sendPaymentDocumentToTg(this.task.id).then(()=>{this.alertStore.show("Чек отправлен вам в телеграм бот!")})},statusClass(l){switch(l){case"pending":return"bg-secondary";case"assigned":return"bg-info";case"delivered":return"bg-primary";case"completed":return"bg-success";case"rejected":return"bg-danger";default:return"bg-dark"}}}},Ot={class:"mb-2"},Lt={class:"mb-2"},Ht={class:"text-muted"},Jt={class:"list-group list-group-flush"},Gt={class:"list-group-item"},Kt={class:"list-group-item"},Qt={class:"list-group-item"},Rt={class:"list-group-item"},Wt={key:0},Xt={key:1},Yt={class:"list-group-item"},Zt={class:"list-group-item"},xt={class:"mt-3"},te={key:0},ee={key:1},se={key:2},le={class:"text-muted small"};function oe(l,e,t,n,p,f){var b,k,o,c,h,w;return i(),a(y,null,[s("h6",Ot,[u(r(t.task.title)+" ",1),s("span",{class:I(["badge",f.statusClass(t.task.status)])},r(p.statusLabels[t.task.status]),3)]),s("div",Lt,[s("p",Ht,r(t.task.description),1),s("ul",Jt,[s("li",Gt,[e[1]||(e[1]=s("strong",null,"Дата встречи:",-1)),u(" "+r(f.formatDate(t.task.due_date)),1)]),s("li",Kt,[e[2]||(e[2]=s("strong",null,"Дата продажи:",-1)),u(" "+r(f.formatDate(t.task.sale_date)),1)]),s("li",Qt,[e[3]||(e[3]=s("strong",null,"Фактическая доставка:",-1)),u(" "+r(f.formatDate(t.task.actual_delivery_date)),1)]),s("li",Rt,[e[4]||(e[4]=s("strong",null,"Тип оплаты:",-1)),t.task.payment_type===0?(i(),a("span",Wt,"Наличный расчет")):d("",!0),t.task.payment_type===1?(i(),a("span",Xt,"Безналичный расчет")):d("",!0)]),s("li",Yt,[e[5]||(e[5]=s("strong",null,"Количество:",-1)),u(" "+r(t.task.quantity),1)]),s("li",Zt,[e[6]||(e[6]=s("strong",null,"Сумма заказа:",-1)),u(" "+r(t.task.total_price)+" ₴ ",1)])]),s("div",xt,[e[13]||(e[13]=s("h6",{class:"fw-bold text-primary"},"Связанные элементы",-1)),s("p",null,[e[7]||(e[7]=s("strong",null,"Отвественный:",-1)),u(" "+r(((b=t.task.agent)==null?void 0:b.name)||"—"),1)]),t.task.customer?(i(),a("p",te,[e[8]||(e[8]=s("strong",null,"Покупатель:",-1)),u(" "+r(((k=t.task.customer)==null?void 0:k.name)||"—"),1)])):d("",!0),s("p",null,[e[9]||(e[9]=s("strong",null,"Поставщик:",-1)),u(" "+r(((o=t.task.supplier)==null?void 0:o.name)||"—"),1)]),s("p",null,[e[10]||(e[10]=s("strong",null,"Продукт:",-1)),u(" "+r(((c=t.task.product)==null?void 0:c.name)||"—"),1)]),t.task.category?(i(),a("p",ee,[e[11]||(e[11]=s("strong",null,"Категория:",-1)),u(" "+r(((h=t.task.category)==null?void 0:h.name)||"—"),1)])):d("",!0),t.task.creator?(i(),a("p",se,[e[12]||(e[12]=s("strong",null,"Создан старшим администратором:",-1)),u(" "+r(((w=t.task.creator)==null?void 0:w.name)||"—"),1)])):d("",!0)]),t.task.payment_document_name?(i(),a("button",{key:0,onClick:e[0]||(e[0]=(...F)=>f.sendPaymentDocumentToTg&&f.sendPaymentDocumentToTg(...F)),class:"btn btn-info p-3 w-100",type:"button"},"Документ чека ")):d("",!0)]),s("div",le," Создано: "+r(f.formatDate(t.task.created_at))+" | Обновлено: "+r(f.formatDate(t.task.updated_at)),1)],64)}const ne=_(Nt,[["render",oe]]),ie={name:"DealForm",props:{modelValue:{type:Object,required:!0}},data(){return{localForm:{...this.modelValue}}},watch:{modelValue:{deep:!0,handler(l){this.localForm={...l}}},localForm:{deep:!0,handler(l){this.$emit("update:modelValue",l)}}},methods:{onSubmit(){this.$emit("submit",this.localForm)}}},ae={class:"form-floating mb-2"},de={class:"form-floating mb-2"},re={class:"form-floating mb-2"};function ue(l,e,t,n,p,f){return i(),a("form",{onSubmit:e[3]||(e[3]=g((...b)=>f.onSubmit&&f.onSubmit(...b),["prevent"]))},[s("div",ae,[m(s("input",{"onUpdate:modelValue":e[0]||(e[0]=b=>p.localForm.sale_date=b),type:"date",class:"form-control",id:"sale_date",required:""},null,512),[[v,p.localForm.sale_date]]),e[4]||(e[4]=s("label",{for:"sale_date"},"Дата",-1))]),s("div",de,[m(s("input",{"onUpdate:modelValue":e[1]||(e[1]=b=>p.localForm.quantity=b),type:"number",class:"form-control",id:"quantity",placeholder:"Количество",required:""},null,512),[[v,p.localForm.quantity,void 0,{number:!0}]]),e[5]||(e[5]=s("label",{for:"quantity"},"Количество",-1))]),s("div",re,[m(s("input",{"onUpdate:modelValue":e[2]||(e[2]=b=>p.localForm.total_price=b),type:"number",step:"0.01",class:"form-control",id:"total_price",placeholder:"Сумма",required:""},null,512),[[v,p.localForm.total_price,void 0,{number:!0}]]),e[6]||(e[6]=s("label",{for:"total_price"},"Сумма сделки",-1))]),e[7]||(e[7]=s("button",{type:"submit",class:"btn btn-success w-100 p-3"}," Подтвердить ",-1))],32)}const me=_(ie,[["render",ue]]),pe={class:"d-flex justify-content-between my-2"},fe={key:0,class:"fw-bold small"},be={class:"list-group"},ye=["onClick"],ce={key:0,class:"fa-solid fa-clock",style:{"margin-left":"8px"}},ge={key:1,class:"badge bg-success"},ve={key:2,class:"badge bg-primary"},ke={key:0,class:"fw-bold mb-0 small",style:{"font-size":"14px"}},Se={key:1,class:"fw-bold mb-0 small",style:{"font-size":"14px"}},he={key:2,class:"fw-bold mb-2",style:{"font-size":"14px"}},Ce={key:0},we={key:1},$e={key:3,class:"fw-bold mb-2",style:{"font-size":"14px"}},Fe={key:4,class:"text-muted"},Pe={key:5,class:"mb-2"},Ie={key:6,class:"mb-2"},De={class:"fw-bold"},Te={key:7,class:"mb-2"},_e={class:"fw-bold"},Ve={key:8,class:"mb-2"},Me={class:"fw-bold"},Ae={key:9,class:"mb-2"},Ue={class:"fw-bold"},je={key:10,class:"mb-2"},qe={class:"fw-bold"},Be={key:11,class:"mb-2"},ze={class:"fw-bold"},Ee={key:12,class:"mb-2"},Ne={class:"fw-bold"},Oe={class:"dropdown"},Le={class:"dropdown-menu dropdown-menu-end"},He={key:0},Je=["onClick"],Ge=["onClick"],Ke=["onClick"],Qe={key:0},Re=["onClick"],We={key:1},Xe=["onClick"],Ye=["onClick"],Ze=["onClick"],xe=["onClick"],ts={key:1,class:"alert alert-info mt-3"},es={class:"modal fade",id:"editSaleModal",tabindex:"-1"},ss={class:"modal-dialog modal-fullscreen"},ls={class:"modal-content"},os={class:"modal-body"},ns={class:"modal fade",id:"viewSaleModal",tabindex:"-1"},is={class:"modal-dialog modal-lg"},as={class:"modal-content"},ds={class:"modal-body"},rs={class:"modal fade",id:"confirmDealModal",tabindex:"-1"},us={class:"modal-dialog"},ms={class:"modal-content"},ps={class:"modal-body"},fs={class:"modal fade",id:"paymentConfirmForm",tabindex:"-1"},bs={class:"modal-dialog"},ys={class:"modal-content"},cs={class:"modal-body"},gs={class:"form-floating mb-2"},vs={class:"form-floating mb-2"},ks=["required"],Ss={class:"form-check form-switch mb-2"},hs={name:"SaleList",props:["forSelect","adminId","agentId","productId","customerId","supplierId"],data(){return{selection:[],field_visible:null,sales:[],search:"",alertStore:H(),userStore:J(),salesStore:T(),agentStore:W(),modalStore:x(),selectedSale:null,saleStatuses:{pending:"В ожидании",assigned:"Назначено",completed:"Завершено",rejected:"Отклонено",delivered:"Доставляется"},paymentConfirmForm:{file:null,payment_type:0,receipt_is_lost:!1},dealForm:{sale_date:new Date().toISOString().split("T")[0],quantity:0,total_price:0}}},computed:{user(){return this.userStore.self||null},filteredSales(){return this.salesStore.items.filter(l=>l.title.toLowerCase().includes(this.search.toLowerCase()))}},created(){this.salesStore.setFilters({created_by_id:this.adminId||null,customer_id:this.customerId||null,product_id:this.productId||null,supplier_id:this.supplierId||null}),this.salesStore.fetchFiltered()},methods:{async sendPaymentDocumentToTg(l){await this.salesStore.sendPaymentDocumentToTg(l).then(()=>{this.alertStore.show("Чек отправлен вам в телеграм бот!")})},selectAll(){this.selection.length===0?this.salesStore.items.forEach(l=>{this.selection.indexOf(l.id)===-1&&this.selection.push(l.id)}):this.selection=[]},toggleSelection(l){let e=this.selection.findIndex(t=>t===l);e===-1?this.selection.push(l):this.selection.splice(e,1)},onFileChange(l){this.paymentConfirmForm.file=l.target.files[0]},async fetchData(l=1){await this.salesStore.fetchAllByPage(l);const e=bootstrap.Modal.getInstance(document.getElementById("editSaleModal"));e&&e.hide();const t=bootstrap.Modal.getInstance(document.getElementById("confirmDealModal"));t&&t.hide()},async fetchDataByUrl(l){await this.salesStore.fetchByUrl(l)},openEdit(l){this.selectedSale=null,this.$nextTick(()=>{this.selectedSale=l,new bootstrap.Modal(document.getElementById("editSaleModal")).show()})},confirmDelete(l){var e;this.selectedSale=l,this.modalStore.open(`Вы уверены, что хотите удалить ${(e=this.selectedSale)==null?void 0:e.title}?`,()=>this.salesStore.deleteSale(this.selectedSale.id),()=>this.modalStore.close())},confirmCancelDeal(l){var e;this.selectedSale=l,this.modalStore.open(`Вы уверены, что хотите отменить сделку ${(e=this.selectedSale)==null?void 0:e.title}?`,()=>this.salesStore.cancelDeal(l),()=>this.modalStore.close())},async deleteSale(){try{await this.salesStore.deleteSale(),bootstrap.Modal.getInstance(document.getElementById("deleteSaleModal")).hide()}catch(l){console.error("Ошибка удаления продажи:",l)}},openView(l){this.selectedSale=null,this.$nextTick(()=>{this.selectedSale=l,new bootstrap.Modal(document.getElementById("viewSaleModal")).show()})},openConfirmPayment(l){this.selectedSale=null,this.$nextTick(()=>{this.selectedSale=l,this.paymentConfirmForm.payment_type=l.payment_type,new bootstrap.Modal(document.getElementById("paymentConfirmForm")).show()})},acceptAll(){this.modalStore.open("Вы уверены, что хотите подтвердить все выбранные заявки? Будет подтвержден факт доставки и факт оплаты",()=>{this.salesStore.acceptAll(this.selection).then(()=>{this.salesStore.fetchFiltered()}),this.selection=[]},()=>{this.modalStore.close(),this.selection=[]})},openConfirmDeal(l){this.selectedSale=null,this.$nextTick(()=>{this.selectedSale=l,this.dealForm.quantity=l.quantity,this.dealForm.id=l.id,this.dealForm.total_price=l.total_price,new bootstrap.Modal(document.getElementById("confirmDealModal")).show()})},async confirmPayment(){this.paymentConfirmForm.id=this.selectedSale.id,await this.salesStore.confirmPayment(this.paymentConfirmForm),bootstrap.Modal.getInstance(document.getElementById("paymentConfirmForm")).hide()},async confirmDeal(){this.dealForm.id=this.selectedSale.id,await this.salesStore.confirmDeal(this.dealForm),bootstrap.Modal.getInstance(document.getElementById("confirmDealModal")).hide()},async cancelDeal(l){try{await this.salesStore.cancelDeal(l)}catch(e){console.error("Ошибка отмены сделки:",e)}},applyFilters(l){var p;this.field_visible=l.field_visible;let e=l.size||30,t=l.page||1;const n=l.only_my_tasks||(((p=this.user)==null?void 0:p.role)||0)<3;delete l.field_visible,delete l.only_my_tasks,this.salesStore.setFilters(l),n?this.salesStore.selfSalesFiltered(t,e):this.salesStore.fetchFiltered(t,e)}}},Cs=Object.assign(hs,{setup(l){return(e,t)=>(i(),a(y,null,[m(s("input",{"onUpdate:modelValue":t[0]||(t[0]=n=>e.search=n),type:"text",class:"form-control mb-2",placeholder:"Поиск по названию..."},null,512),[[v,e.search]]),C(Et,{onApplyFilters:e.applyFilters},null,8,["onApplyFilters"]),s("div",pe,[s("div",null,[s("a",{href:"javascript:void(0)",onClick:t[1]||(t[1]=(...n)=>e.selectAll&&e.selectAll(...n)),style:{"font-size":"12px"},class:"small fw-bold"},"Выделить все"),e.selection.length>0?(i(),a("a",{key:0,href:"javascript:void(0)",onClick:t[2]||(t[2]=(...n)=>e.acceptAll&&e.acceptAll(...n)),style:{"font-size":"12px"},class:"small text-danger mx-2 fw-bold"},"Подтвердить заявки ("+r(e.selection.length)+")",1)):d("",!0)]),e.salesStore.pagination?(i(),a("span",fe,"Всего "+r(e.salesStore.pagination.total)+" ед.",1)):d("",!0)]),s("ul",be,[(i(!0),a(y,null,L(e.filteredSales,n=>{var p,f,b,k,o,c,h,w,F,V,M,A,U,j,q,B,z,E,N;return i(),a("li",{class:I([{"border-primary":e.selection.indexOf(n.id)!==-1},"list-group-item d-flex justify-content-between align-items-center"]),key:n.id},[s("div",null,[s("p",{class:"fw-bold mb-2",onClick:S=>e.toggleSelection(n.id)},[n.payment_type===0?(i(),a("span",{key:0,class:I(["badge",{"bg-warning":!n.sale_date,"bg-success":n.sale_date}])},[t[8]||(t[8]=s("i",{class:"fa-solid fa-money-bill"},null,-1)),n.sale_date?d("",!0):(i(),a("i",ce))],2)):d("",!0),n.payment_type===1?(i(),a("span",ge,[...t[9]||(t[9]=[s("i",{class:"fa-solid fa-credit-card"},null,-1)])])):d("",!0),(p=e.field_visible)!=null&&p.id?(i(),a("span",ve,"#"+r(n.id),1)):d("",!0),u(" "+r(n.title),1)],8,ye),((f=e.field_visible)!=null&&f.due_date,i(),a("p",ke,"Дата задания "+r(n.due_date||"не указана"),1)),((b=e.field_visible)!=null&&b.sale_date,i(),a("p",Se,"Дата продажи "+r(n.sale_date||"не указана"),1)),(k=e.field_visible)!=null&&k.payment_type?(i(),a("p",he,[t[10]||(t[10]=u(" Тип оплаты ",-1)),n.payment_type===0?(i(),a("span",Ce,"Наличный расчет")):d("",!0),n.payment_type===1?(i(),a("span",we,"Безналичный расчет")):d("",!0)])):d("",!0),(o=e.field_visible)!=null&&o.actual_delivery_date?(i(),a("p",$e," Фактическая дата доставки "+r(n.actual_delivery_date||"не указана"),1)):d("",!0),((c=e.field_visible)!=null&&c.status,i(),a("small",Fe,[t[11]||(t[11]=u("Статус: ",-1)),s("span",{class:I(["badge",{"bg-warning":n.status==="pending","bg-info":n.status==="assigned","bg-primary":n.status==="delivered","bg-success":n.status==="completed","bg-danger":n.status==="rejected"}])},r(e.saleStatuses[n.status]),3)])),((h=e.field_visible)!=null&&h.description,i(),a("p",Pe,r(n.description),1)),(w=e.field_visible)!=null&&w.quantity?(i(),a("p",Ie,[t[12]||(t[12]=u("Доставляемое число товара ",-1)),s("span",De,r(n.quantity||"не указана"),1),t[13]||(t[13]=u(" ед.",-1))])):d("",!0),(F=e.field_visible)!=null&&F.total_price?(i(),a("p",Te,[t[14]||(t[14]=u("Сумма заказа ",-1)),s("span",_e,r(n.total_price),1),t[15]||(t[15]=u(" руб.",-1))])):d("",!0),((V=e.field_visible)!=null&&V.agent_id,i(),a("p",Ve,[t[16]||(t[16]=u("Администратор ",-1)),s("span",Me,r(((M=n.agent)==null?void 0:M.name)||n.agent_id||"-"),1)])),(A=e.field_visible)!=null&&A.customer_id?(i(),a("p",Ae,[t[17]||(t[17]=u("Клиент ",-1)),s("span",Ue,r(((U=n.customer)==null?void 0:U.name)||n.customer_id||"-"),1)])):d("",!0),(j=e.field_visible)!=null&&j.supplier_id?(i(),a("p",je,[t[18]||(t[18]=u("Поставщик ",-1)),s("span",qe,r(((q=n.supplier)==null?void 0:q.name)||n.supplier_id||"-"),1)])):d("",!0),(B=e.field_visible)!=null&&B.created_by_id?(i(),a("p",Be,[t[19]||(t[19]=u("Старший администратор ",-1)),s("span",ze,r(((z=n.creator)==null?void 0:z.name)||n.created_by_id||"-"),1)])):d("",!0),(E=e.field_visible)!=null&&E.product_id?(i(),a("p",Ee,[t[20]||(t[20]=u("Товар ",-1)),s("span",Ne,r(((N=n.product)==null?void 0:N.name)||n.product_id||"-"),1)])):d("",!0)]),s("div",Oe,[t[23]||(t[23]=s("button",{class:"btn btn-sm",type:"button","data-bs-toggle":"dropdown"},[s("i",{class:"fas fa-bars"})],-1)),s("ul",Le,[l.forSelect?(i(),a("li",He,[s("a",{class:"dropdown-item",href:"#",onClick:g(S=>e.$emit("select",n),["prevent"])},"Выбрать",8,Je)])):d("",!0),l.forSelect?d("",!0):(i(),a(y,{key:1},[s("li",null,[s("a",{class:"dropdown-item",href:"javascript:void(0)",onClick:g(S=>e.openView(n),["prevent"])},"Просмотреть",8,Ge)]),s("li",null,[s("a",{class:"dropdown-item",href:"javascript:void(0)",onClick:g(S=>e.openEdit(n),["prevent"])},"Редактировать",8,Ke)]),n.status!=="completed"?(i(),a("li",Qe,[s("a",{class:"dropdown-item text-success",href:"javascript:void(0)",onClick:g(S=>e.openConfirmDeal(n),["prevent"])},"Подтвердить доставку",8,Re)])):d("",!0),n.payment_type===0&&!n.sale_date?(i(),a("li",We,[s("a",{class:"dropdown-item text-success",href:"javascript:void(0)",onClick:g(S=>e.openConfirmPayment(n),["prevent"])},"Подтвердить оплату",8,Xe)])):d("",!0),n.payment_document_name?(i(),a(y,{key:2},[t[21]||(t[21]=s("li",null,[s("hr",{class:"dropdown-divider"})],-1)),s("li",null,[s("a",{class:"dropdown-item text-success",href:"javascript:void(0)",onClick:g(S=>e.sendPaymentDocumentToTg(n.id),["prevent"])},"Отправить документ в чат",8,Ye)])],64)):d("",!0),t[22]||(t[22]=s("li",null,[s("hr",{class:"dropdown-divider"})],-1)),s("li",null,[s("a",{class:"dropdown-item text-danger",href:"javascript:void(0)",onClick:g(S=>e.confirmDelete(n),["prevent"])},"Удалить",8,Ze)]),s("li",null,[s("a",{class:"dropdown-item text-danger",href:"javascript:void(0)",onClick:g(S=>e.confirmCancelDeal(n),["prevent"])},"Отменить сделку",8,xe)])],64))])])],2)}),128))]),e.salesStore.items.length>0?(i(),P(Q,{key:0,pagination:e.salesStore.pagination,onPageChanged:e.fetchDataByUrl},null,8,["pagination","onPageChanged"])):d("",!0),e.salesStore.items.length===0?(i(),a("div",ts," На текущий момент у вас нет продаж. ")):d("",!0),s("div",es,[s("div",ss,[s("div",ls,[t[24]||(t[24]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},"Редактирование задания"),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",os,[e.selectedSale?(i(),P(K,{key:0,initialData:e.selectedSale,onSaved:e.fetchData},null,8,["initialData","onSaved"])):d("",!0)])])])]),s("div",ns,[s("div",is,[s("div",as,[t[25]||(t[25]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},"Карточка задания"),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",ds,[e.selectedSale?(i(),P(ne,{key:0,task:e.selectedSale},null,8,["task"])):d("",!0)])])])]),s("div",rs,[s("div",us,[s("div",ms,[t[26]||(t[26]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},"Подтверждение сделки"),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",ps,[e.selectedSale?(i(),P(me,{key:0,modelValue:e.dealForm,"onUpdate:modelValue":t[3]||(t[3]=n=>e.dealForm=n),onSubmit:e.confirmDeal},null,8,["modelValue","onSubmit"])):d("",!0)])])])]),s("div",fs,[s("div",bs,[s("div",ys,[t[33]||(t[33]=s("div",{class:"modal-header"},[s("h5",{class:"modal-title"},"Подтверждение оплаты"),s("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),s("div",cs,[s("form",{onSubmit:t[7]||(t[7]=g((...n)=>e.confirmPayment&&e.confirmPayment(...n),["prevent"]))},[s("div",gs,[m(s("select",{class:"form-select","onUpdate:modelValue":t[4]||(t[4]=n=>e.paymentConfirmForm.payment_type=n),id:"payment-type","aria-label":"Floating label select example"},[...t[27]||(t[27]=[s("option",{value:"0"},"Наличный расчет",-1),s("option",{value:"1"},"Безналичный расчет",-1)])],512),[[$,e.paymentConfirmForm.payment_type]]),t[28]||(t[28]=s("label",{for:"payment-type"},"Тип оплаты",-1))]),e.paymentConfirmForm.payment_type==="1"?(i(),a(y,{key:0},[t[31]||(t[31]=s("h6",null,"Фотография чека",-1)),s("div",vs,[s("input",{type:"file",class:"form-control",onChange:t[5]||(t[5]=(...n)=>e.onFileChange&&e.onFileChange(...n)),accept:".jpg,.png,.pdf",required:!e.paymentConfirmForm.receipt_is_lost},null,40,ks),t[29]||(t[29]=s("label",{for:"payment-type"},"Прикрепить",-1))]),s("div",Ss,[m(s("input",{"onUpdate:modelValue":t[6]||(t[6]=n=>e.paymentConfirmForm.receipt_is_lost=n),class:"form-check-input",type:"checkbox",role:"switch",id:"need_automatic_naming"},null,512),[[D,e.paymentConfirmForm.receipt_is_lost]]),t[30]||(t[30]=s("label",{class:"form-check-label",for:"need_automatic_naming"},"Чек был утрачен ",-1))])],64)):d("",!0),t[32]||(t[32]=s("button",{type:"submit",class:"btn btn-success w-100 p-3"},"Подтвердить",-1))],32)])])])])],64))}}),Ms=_(Cs,[["__scopeId","data-v-6ea47e67"]]);export{Ms as S};
