import{c as n,o as r,b as t,i as k,e as p,t as b,F as S,r as w,h as v,w as m,v as u,k as M,f as B,I as P,d as $,a as I,H as O,n as G}from"./app-CuqcIkQd.js";import{P as N}from"./Pagination-B42jjdvD.js";import{_ as D}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as c}from"./makeAxiosFactory-DPBmHXy1.js";import{u as A}from"./users-Cfl8QK4b.js";import{u as j}from"./useConfitmModalStore-CCtJZJJM.js";import{d as z}from"./index-DuS1IyIQ.js";const x={name:"SupplierFilter",data(){return{field_visible:[],filters:{name:"",description:"",address:"",phone:"",email:"",percent:"",birthday:""},sort:{field:"id",direction:"asc"},sortableFields:{id:"№",name:"Название",description:"Описание",address:"Адрес",phone:"Телефон",email:"Email",percent:"Процент",birthday:"Дата рождения"}}},created(){const s=["name","id","description","phone"];for(const e in this.sortableFields)this.field_visible[e]=s.includes(e)},methods:{openFilter(){new bootstrap.Modal(document.getElementById("supplierFilterModal")).show()},changeSort(s){this.sort.field===s?this.sort.direction=this.sort.direction==="asc"?"desc":"asc":(this.sort.field=s,this.sort.direction="asc"),this.$emit("apply-filters",{filters:this.filters,sort:this.sort})},applyFilters(){const s={filters:this.filters,sort:this.sort,field_visible:this.field_visible};this.$emit("apply-filters",s),bootstrap.Modal.getInstance(document.getElementById("supplierFilterModal")).hide()}}},L={class:"d-flex mb-2"},q={class:"dropdown d-inline-block ms-2"},H={style:{"font-size":"12px"},class:"btn btn-outline-secondary",type:"button","data-bs-toggle":"dropdown"},R={key:0},W={key:1},J={key:2},K={class:"dropdown-menu"},Q=["onClick"],X={class:"modal fade",id:"supplierFilterModal",tabindex:"-1"},Y={class:"modal-dialog modal-fullscreen"},Z={class:"modal-body"},ee={class:"form-floating mb-2"},te={class:"form-floating mb-2"},se={class:"form-floating mb-2"},ie={class:"form-floating mb-2"},oe={class:"form-floating mb-2"},le={class:"form-floating mb-2"},re={class:"form-floating mb-2"},ne=["onUpdate:modelValue","id"],de=["for"];function ae(s,e,o,h,i,l){return r(),n(S,null,[t("div",L,[t("button",{style:{"font-size":"12px"},class:"btn btn-secondary",onClick:e[0]||(e[0]=(...d)=>l.openFilter&&l.openFilter(...d))},"Фильтр"),t("div",q,[t("button",H,[k(b(i.sortableFields[i.sort.field].slice(0,17))+" ",1),i.sortableFields[i.sort.field].length>17?(r(),n("span",R,"...")):p("",!0),e[11]||(e[11]=k(" (",-1)),i.sort.direction==="asc"?(r(),n("span",W,[...e[9]||(e[9]=[t("i",{class:"fa-solid fa-arrow-down"},null,-1)])])):p("",!0),i.sort.direction==="desc"?(r(),n("span",J,[...e[10]||(e[10]=[t("i",{class:"fa-solid fa-arrow-up"},null,-1)])])):p("",!0),e[12]||(e[12]=k(") ",-1))]),t("ul",K,[(r(!0),n(S,null,w(i.sortableFields,(d,f)=>(r(),n("li",{key:f},[t("a",{class:"dropdown-item",onClick:a=>l.changeSort(f)},b(d),9,Q)]))),128))])])]),t("div",X,[t("div",Y,[t("form",{class:"modal-content",onSubmit:e[8]||(e[8]=v((...d)=>l.applyFilters&&l.applyFilters(...d),["prevent"]))},[e[21]||(e[21]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"Фильтры поставщиков"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",Z,[t("div",ee,[m(t("input",{"onUpdate:modelValue":e[1]||(e[1]=d=>i.filters.name=d),class:"form-control",id:"nameInput",placeholder:"Название"},null,512),[[u,i.filters.name]]),e[13]||(e[13]=t("label",{for:"nameInput"},"Название",-1))]),t("div",te,[m(t("input",{"onUpdate:modelValue":e[2]||(e[2]=d=>i.filters.description=d),class:"form-control",id:"descInput",placeholder:"Описание"},null,512),[[u,i.filters.description]]),e[14]||(e[14]=t("label",{for:"descInput"},"Описание",-1))]),t("div",se,[m(t("input",{"onUpdate:modelValue":e[3]||(e[3]=d=>i.filters.address=d),class:"form-control",id:"addressInput",placeholder:"Адрес"},null,512),[[u,i.filters.address]]),e[15]||(e[15]=t("label",{for:"addressInput"},"Адрес",-1))]),t("div",ie,[m(t("input",{"onUpdate:modelValue":e[4]||(e[4]=d=>i.filters.phone=d),class:"form-control",id:"phoneInput",placeholder:"Телефон"},null,512),[[u,i.filters.phone]]),e[16]||(e[16]=t("label",{for:"phoneInput"},"Телефон",-1))]),t("div",oe,[m(t("input",{"onUpdate:modelValue":e[5]||(e[5]=d=>i.filters.email=d),class:"form-control",id:"emailInput",placeholder:"Email"},null,512),[[u,i.filters.email]]),e[17]||(e[17]=t("label",{for:"emailInput"},"Email",-1))]),t("div",le,[m(t("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=d=>i.filters.percent=d),class:"form-control",id:"percentInput",placeholder:"Процент"},null,512),[[u,i.filters.percent]]),e[18]||(e[18]=t("label",{for:"percentInput"},"Процент",-1))]),t("div",re,[m(t("input",{type:"date","onUpdate:modelValue":e[7]||(e[7]=d=>i.filters.birthday=d),class:"form-control",id:"birthdayInput"},null,512),[[u,i.filters.birthday]]),e[19]||(e[19]=t("label",{for:"birthdayInput"},"Дата рождения",-1))]),e[20]||(e[20]=t("h6",{class:"mt-3"},"Отображаемые поля",-1)),(r(!0),n(S,null,w(i.sortableFields,(d,f)=>(r(),n("div",{key:f,class:"form-check form-switch mb-2"},[m(t("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":a=>i.field_visible[f]=a,id:`switch-${f}`},null,8,ne),[[M,i.field_visible[f]]]),t("label",{class:"form-check-label",for:`switch-${f}`},b(d),9,de)]))),128))]),e[22]||(e[22]=t("div",{class:"modal-footer"},[t("button",{type:"submit",class:"btn btn-primary w-100 p-3"},"Применить")],-1))],32)])])],64)}const pe=D(x,[["render",ae]]),y="/bot-api/suppliers",T=B("suppliers",{state:()=>({items:[],loading:!1,error:null,sort:{field:"id",direction:"desc"},pagination:null}),getters:{byId:s=>e=>s.items.find(o=>o.id===e)},actions:{setFilters(s){this.filters=s},setSort(s,e){this.sort={field:s,direction:e}},async fetchFiltered(s=1,e=30){const o=new URLSearchParams;Object.entries(this.filters).forEach(([i,l])=>{l!=null&&l!==""&&o.append(i,String(l))}),o.append("sort_field",this.sort.field),o.append("sort_direction",this.sort.direction),o.append("page",String(s)),o.append("size",String(e));const{data:h}=await c(`${y}?${o.toString()}`,"GET");return this.items=h.data,this.pagination=h,!0},async fetchAll(){this.loading=!0,this.error=null;try{const{data:s}=await c(`${y}`,"GET");this.items=s}catch(s){this.error=(s==null?void 0:s.message)||"Failed to load suppliers"}finally{this.loading=!1}},async fetchAllByPage(s=1){const{data:e}=await c(`${y}?page=${s}`,"GET");this.items=e.data,this.pagination=e},async fetchByUrl(s){const{data:e}=await c(s,"GET");this.items=e.data,this.pagination=e},async fetchOne(s){try{const{data:e}=await c(`${y}/${s}`,"GET");return e}catch(e){throw this.error=(e==null?void 0:e.message)||"Failed to load supplier",e}},async fetchSupplierWithProducts(s=1){const{data:e}=await c(`${y}/with-products?page=${s}`,"GET");this.items=e.data,this.pagination=e},async loadMoreSupplierProducts(s,e){const{data:o}=await c(`/fetch-next-products/${s}/products?page=${e}`,"GET");this.items.find(i=>i.id===s).products.push(...o.data)},async create(s){const{data:e}=await c(`${y}`,"POST",s);return this.items.push(e),e},async toggleFavorites(s){const{data:e}=await c(`${y}/toggle-favorite`,"POST",{id:s})},async removeAll(s){await c(`${y}/remove-all`,"POST",{ids:s}),s.forEach(e=>{this.items=this.items.filter(o=>o.id!==e)})},async update(s,e){const{data:o}=await c(`${y}/${s}`,"PUT",e),h=this.items.findIndex(i=>i.id===s);return h!==-1&&(this.items[h]=o),o},async remove(s){await c(`${y}/${s}`,"DELETE"),this.items=this.items.filter(e=>e.id!==s)}}}),me={name:"SupplierForm",props:{isSimple:{type:Boolean,default:!1},initialData:{type:Object,default:null}},computed:{user(){return this.userStore.self||null}},data(){return{userStore:A(),suppliersStore:T(),isEdit:!1,form:{name:"",description:"",address:"",phone:"",work_phone:"",percent:8,birthday:"",email:""}}},created(){this.initialData&&(this.form={...this.initialData},this.isEdit=!0)},methods:{submitForm(){(this.isEdit?this.suppliersStore.update(this.form.id,this.form):this.suppliersStore.create(this.form)).then(e=>{console.log("test",e),this.$emit("saved",e)})}}},ue={class:"form-floating mb-2"},fe={class:"form-floating mb-2"},ce={class:"form-floating mb-2"},he={class:"form-floating mb-2"},be={class:"form-floating mb-2"},ye={key:0,class:"form-floating mb-2"},Se={class:"form-floating mb-2"},ge={class:"form-floating mb-2"};function ve(s,e,o,h,i,l){var f;const d=P("mask");return r(),n("form",{onSubmit:e[8]||(e[8]=v((...a)=>l.submitForm&&l.submitForm(...a),["prevent"]))},[t("div",ue,[m(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>i.form.name=a),type:"text",class:"form-control",id:"name",placeholder:"Название",required:""},null,512),[[u,i.form.name]]),e[9]||(e[9]=t("label",{for:"name"},"Имя поставщика",-1))]),t("div",fe,[m(t("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>i.form.phone=a),type:"text",class:"form-control",id:"phone",placeholder:"Телефон",required:""},null,512),[[u,i.form.phone],[d,"+7(###) ###-##-##"]]),e[10]||(e[10]=t("label",{for:"phone"},"Телефон",-1))]),o.isSimple?p("",!0):(r(),n(S,{key:0},[t("div",ce,[m(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=a=>i.form.description=a),class:"form-control",id:"description",placeholder:"Описание",style:{height:"100px"}},null,512),[[u,i.form.description]]),e[11]||(e[11]=t("label",{for:"description"},"Описание",-1))]),t("div",he,[m(t("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>i.form.address=a),type:"text",class:"form-control",id:"address",placeholder:"Адрес"},null,512),[[u,i.form.address]]),e[12]||(e[12]=t("label",{for:"address"},"Адрес",-1))]),t("div",be,[m(t("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>i.form.work_phone=a),type:"text",class:"form-control",id:"work_phone",placeholder:"Телефон"},null,512),[[u,i.form.work_phone],[d,"+7(###) ###-##-##"]]),e[13]||(e[13]=t("label",{for:"work_phone"},"Рабочий телефон",-1))]),(((f=l.user)==null?void 0:f.role)||0)>=3?(r(),n("div",ye,[m(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>i.form.percent=a),type:"number",step:"0.01",class:"form-control",id:"percent",placeholder:"Процент"},null,512),[[u,i.form.percent]]),e[14]||(e[14]=t("label",{for:"percent"},"Процент, %",-1))])):p("",!0),t("div",Se,[m(t("input",{"onUpdate:modelValue":e[6]||(e[6]=a=>i.form.birthday=a),type:"date",class:"form-control",id:"birthday",placeholder:"Дата рождения"},null,512),[[u,i.form.birthday]]),e[15]||(e[15]=t("label",{for:"birthday"},"Дата рождения",-1))]),t("div",ge,[m(t("input",{"onUpdate:modelValue":e[7]||(e[7]=a=>i.form.email=a),type:"email",class:"form-control",id:"email",placeholder:"Email"},null,512),[[u,i.form.email]]),e[16]||(e[16]=t("label",{for:"email"},"Email",-1))])],64)),e[17]||(e[17]=t("button",{type:"submit",class:"btn btn-primary w-100 p-3"},"Сохранить",-1))],32)}const _=D(me,[["render",ve]]),ke={class:"form-check form-switch mb-2"},we={class:"input-group mb-2"},Fe={class:"form-floating"},Ve={key:0,class:"d-flex"},Ee={class:"list-group"},Ue=["onClick"],Ce=["onClick"],$e={key:0,class:"badge bg-primary"},Ie={key:1,class:"badge bg-primary rounded-pill"},_e={key:0,class:"mb-0"},Me={key:1,class:"mb-0 fw-bold small"},De={key:2,class:"mb-2"},Ae={key:3,class:"mb-2"},Te={key:4,class:"mb-2"},Be={class:"d-flex justify-content-between"},Pe=["onClick"],Oe={key:0},Ge={key:1},Ne={class:"dropdown flex-shrink-0"},je={class:"dropdown-menu dropdown-menu-end"},ze={key:0},xe=["onClick"],Le=["onClick"],qe={key:0},He=["onClick"],Re={key:1,class:"alert alert-info mt-3"},We={class:"modal fade",id:"editSupplierModal",tabindex:"-1"},Je={class:"modal-dialog"},Ke={class:"modal-content"},Qe={class:"modal-body"},Xe={name:"SupplierListGroup",props:["forSelect"],data(){return{field_visible:null,modalStore:j(),userStore:A(),alertStore:O(),selection:[],search:null,showSimpleSupplierForm:!1,selectedSupplier:null,suppliersStore:T()}},watch:{search:function(s,e){this.findSupplier()}},computed:{favorites(){var s;return((s=this.user.agent)==null?void 0:s.favorite_suppliers)||[]},user(){return this.userStore.self||null}},created(){this.fetchData()},methods:{searchDebounced(){z(()=>{this.findSupplier()},300)},findSupplier(){this.suppliersStore.setFilters({name:this.search||""}),this.suppliersStore.setSort("id","desc"),this.suppliersStore.fetchFiltered(0,30)},addNewSupplier(s){this.$emit("select",s)},applyFilters(s){this.field_visible=s.field_visible;let e=s.size||30,o=s.page||0;delete s.field_visible,this.suppliersStore.setFilters(s.filters),this.suppliersStore.setSort(s.sort.field,s.sort.direction),this.suppliersStore.fetchFiltered(o,e)},toggleFavorites(s){this.suppliersStore.toggleFavorites(s).then(()=>{this.alertStore.show(this.favorites.indexOf(s)!==-1?"Убираем из избранного":"Добавляем в избранное","success"),this.userStore.fetchSelf()})},removeAll(){this.modalStore.open("Вы уверены, что хотите удалить все выбранные элементы?",()=>{this.suppliersStore.removeAll(this.selection),this.selection=[]},()=>{this.modalStore.close(),this.selection=[]})},openEditModal(s){this.selectedSupplier=null,this.$nextTick(()=>{this.selectedSupplier=s,new bootstrap.Modal(document.getElementById("editSupplierModal")).show()})},toggleSelection(s){let e=this.selection.findIndex(o=>o===s);e===-1?this.selection.push(s):this.selection.splice(e,1)},selectAll(){this.selection.length===0?this.suppliersStore.items.forEach(s=>{this.selection.indexOf(s.id)===-1&&this.selection.push(s.id)}):this.selection=[]},async fetchData(s=0){await this.suppliersStore.fetchAllByPage(s)},async fetchDataByUrl(s){await this.suppliersStore.fetchByUrl(s)},selectSupplier(s){this.forSelect&&this.$emit("select",s)},openDeleteModal(s){this.selectedSupplier=s,this.modalStore.open(`Вы уверены, что хотите удалить ${this.selectedSupplier.name}?`,()=>{this.suppliersStore.remove(this.selectedSupplier.id),this.selection=[],this.fetchData()},()=>{this.modalStore.close(),this.selection=[]})}}},lt=Object.assign(Xe,{setup(s){return(e,o)=>{var h,i;return r(),n(S,null,[t("div",ke,[m(t("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":o[0]||(o[0]=l=>e.showSimpleSupplierForm=l),id:"show-simple-supplier-form"},null,512),[[M,e.showSimpleSupplierForm]]),o[5]||(o[5]=t("label",{class:"form-check-label",for:"show-simple-supplier-form"}," Добавить и выбрать нового поставщика ",-1))]),e.showSimpleSupplierForm?(r(),$(_,{key:0,onSaved:e.addNewSupplier,class:"mb-2"},null,8,["onSaved"])):p("",!0),e.showSimpleSupplierForm?p("",!0):(r(),n(S,{key:1},[t("div",we,[t("div",Fe,[m(t("input",{class:"form-control",type:"search","onUpdate:modelValue":o[1]||(o[1]=l=>e.search=l),id:"supplierInput",placeholder:"Поставщик"},null,512),[[u,e.search]]),o[6]||(o[6]=t("label",{for:"supplierInput"},"Поставщик",-1))]),t("button",{onClick:o[2]||(o[2]=(...l)=>e.findSupplier&&e.findSupplier(...l)),type:"button",class:"btn btn-outline-light text-primary find-btn"}," Найти ")]),s.forSelect?p("",!0):(r(),n(S,{key:0},[I(pe,{onApplyFilters:e.applyFilters},null,8,["onApplyFilters"]),(((h=e.user)==null?void 0:h.role)||0)>=3?(r(),n("div",Ve,[t("a",{href:"javascript:void(0)",onClick:o[3]||(o[3]=(...l)=>e.selectAll&&e.selectAll(...l)),class:"small"},"Выделить все"),e.selection.length>0?(r(),n("a",{key:0,href:"javascript:void(0)",onClick:o[4]||(o[4]=(...l)=>e.removeAll&&e.removeAll(...l)),class:"small text-danger mx-2"},"Удалить выделенное")):p("",!0)])):p("",!0)],64)),t("ul",Ee,[(r(!0),n(S,null,w(e.suppliersStore.items,l=>{var d,f,a,F,V,E,U,C;return r(),n("li",{key:l.id,class:G(["list-group-item d-flex justify-content-between align-items-start",{"border-primary":e.selection.indexOf(l.id)!==-1}])},[t("div",{class:"flex-grow-1 me-3 text-break",onClick:g=>e.selectSupplier(l)},[t("div",{class:"fw-bold",onClick:g=>e.toggleSelection(l.id)},[(d=e.field_visible)!=null&&d.id?(r(),n("span",$e,"#"+b(l.id),1)):p("",!0),k(b(l.name)+" ",1),(f=e.field_visible)!=null&&f.percent?(r(),n("span",Ie,b(l.percent)+"%",1)):p("",!0)],8,Ce),((a=e.field_visible)!=null&&a.description,r(),n("p",_e,b(l.description||"-"),1)),((F=e.field_visible)!=null&&F.phone,r(),n("p",Me,b(l.phone),1)),(V=e.field_visible)!=null&&V.email?(r(),n("p",De,b(l.email),1)):p("",!0),(E=e.field_visible)!=null&&E.address?(r(),n("p",Ae,b(l.address),1)):p("",!0),(U=e.field_visible)!=null&&U.birthday?(r(),n("p",Te,b(l.birthday),1)):p("",!0)],8,Ue),t("div",Be,[t("button",{type:"button",class:"btn btn-sm",onClick:g=>e.toggleFavorites(l.id)},[e.favorites.indexOf(l.id)===-1?(r(),n("span",Oe,[...o[7]||(o[7]=[t("i",{class:"fa-regular fa-star text-danger"},null,-1)])])):(r(),n("span",Ge,[...o[8]||(o[8]=[t("i",{class:"fa-solid fa-star text-danger"},null,-1)])]))],8,Pe),t("div",Ne,[o[9]||(o[9]=t("button",{class:"btn btn-sm",type:"button","data-bs-toggle":"dropdown"},[t("i",{class:"fas fa-bars"})],-1)),t("ul",je,[s.forSelect?(r(),n("li",ze,[t("a",{class:"dropdown-item",href:"#",onClick:v(g=>e.selectSupplier(l),["prevent"])},"Выбрать",8,xe)])):(r(),n(S,{key:1},[t("li",null,[t("a",{class:"dropdown-item",href:"#",onClick:v(g=>e.openEditModal(l),["prevent"])},"Редактировать",8,Le)]),(((C=e.user)==null?void 0:C.role)||0)>=3?(r(),n("li",qe,[t("a",{class:"dropdown-item text-danger",href:"#",onClick:v(g=>e.openDeleteModal(l),["prevent"])},"Удалить",8,He)])):p("",!0)],64))])])])],2)}),128))]),I(N,{pagination:e.suppliersStore.pagination,onPageChanged:e.fetchDataByUrl},null,8,["pagination","onPageChanged"]),((i=e.suppliersStore.items)==null?void 0:i.length)===0?(r(),n("div",Re," Поставщиков пока нет. ")):p("",!0)],64)),t("div",We,[t("div",Je,[t("div",Ke,[o[10]||(o[10]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"Редактирование категории"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",Qe,[e.selectedSupplier?(r(),$(_,{key:0,"initial-data":e.selectedSupplier,onSaved:e.fetchData},null,8,["initial-data","onSaved"])):p("",!0)])])])])],64)}}});export{_ as S,lt as _,T as u};
