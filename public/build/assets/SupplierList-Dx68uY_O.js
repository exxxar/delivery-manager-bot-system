import{c as d,o as n,b as t,i as k,e as u,t as h,F as y,r as w,h as v,w as a,v as m,k as $,f as D,I as A,d as U,a as C,n as B}from"./app-CdbXviDe.js";import{P as T}from"./Pagination-Chb9bu_k.js";import{_ as M}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{m as c}from"./makeAxiosFactory-DxU7Q411.js";import{u as P}from"./useConfitmModalStore-G99kgfyb.js";const G={name:"SupplierFilter",data(){return{field_visible:[],filters:{name:"",description:"",address:"",phone:"",email:"",percent:"",birthday:""},sort:{field:"id",direction:"asc"},sortableFields:{id:"№",name:"Название",description:"Описание",address:"Адрес",phone:"Телефон",email:"Email",percent:"Процент",birthday:"Дата рождения"}}},created(){const i=["name","id","description","phone"];for(const e in this.sortableFields)this.field_visible[e]=i.includes(e)},methods:{openFilter(){new bootstrap.Modal(document.getElementById("supplierFilterModal")).show()},changeSort(i){this.sort.field===i?this.sort.direction=this.sort.direction==="asc"?"desc":"asc":(this.sort.field=i,this.sort.direction="asc"),this.$emit("apply-filters",{filters:this.filters,sort:this.sort})},applyFilters(){const i={filters:this.filters,sort:this.sort,field_visible:this.field_visible};this.$emit("apply-filters",i),bootstrap.Modal.getInstance(document.getElementById("supplierFilterModal")).hide()}}},N={class:"d-flex mb-2"},O={class:"dropdown d-inline-block ms-2"},j={style:{"font-size":"12px"},class:"btn btn-outline-secondary",type:"button","data-bs-toggle":"dropdown"},z={key:0},L={key:1},q={key:2},x={class:"dropdown-menu"},K=["onClick"],R={class:"modal fade",id:"supplierFilterModal",tabindex:"-1"},W={class:"modal-dialog modal-fullscreen"},H={class:"modal-body"},J={class:"form-floating mb-2"},Q={class:"form-floating mb-2"},X={class:"form-floating mb-2"},Y={class:"form-floating mb-2"},Z={class:"form-floating mb-2"},ee={class:"form-floating mb-2"},te={class:"form-floating mb-2"},se=["onUpdate:modelValue","id"],ie=["for"];function le(i,e,l,f,s,p){return n(),d(y,null,[t("div",N,[t("button",{style:{"font-size":"12px"},class:"btn btn-secondary",onClick:e[0]||(e[0]=(...r)=>p.openFilter&&p.openFilter(...r))},"Фильтр"),t("div",O,[t("button",j,[k(h(s.sortableFields[s.sort.field].slice(0,17))+" ",1),s.sortableFields[s.sort.field].length>17?(n(),d("span",z,"...")):u("",!0),e[11]||(e[11]=k(" (",-1)),s.sort.direction==="asc"?(n(),d("span",L,[...e[9]||(e[9]=[t("i",{class:"fa-solid fa-arrow-down"},null,-1)])])):u("",!0),s.sort.direction==="desc"?(n(),d("span",q,[...e[10]||(e[10]=[t("i",{class:"fa-solid fa-arrow-up"},null,-1)])])):u("",!0),e[12]||(e[12]=k(") ",-1))]),t("ul",x,[(n(!0),d(y,null,w(s.sortableFields,(r,o)=>(n(),d("li",{key:o},[t("a",{class:"dropdown-item",onClick:S=>p.changeSort(o)},h(r),9,K)]))),128))])])]),t("div",R,[t("div",W,[t("form",{class:"modal-content",onSubmit:e[8]||(e[8]=v((...r)=>p.applyFilters&&p.applyFilters(...r),["prevent"]))},[e[21]||(e[21]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"Фильтры поставщиков"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",H,[t("div",J,[a(t("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>s.filters.name=r),class:"form-control",id:"nameInput",placeholder:"Название"},null,512),[[m,s.filters.name]]),e[13]||(e[13]=t("label",{for:"nameInput"},"Название",-1))]),t("div",Q,[a(t("input",{"onUpdate:modelValue":e[2]||(e[2]=r=>s.filters.description=r),class:"form-control",id:"descInput",placeholder:"Описание"},null,512),[[m,s.filters.description]]),e[14]||(e[14]=t("label",{for:"descInput"},"Описание",-1))]),t("div",X,[a(t("input",{"onUpdate:modelValue":e[3]||(e[3]=r=>s.filters.address=r),class:"form-control",id:"addressInput",placeholder:"Адрес"},null,512),[[m,s.filters.address]]),e[15]||(e[15]=t("label",{for:"addressInput"},"Адрес",-1))]),t("div",Y,[a(t("input",{"onUpdate:modelValue":e[4]||(e[4]=r=>s.filters.phone=r),class:"form-control",id:"phoneInput",placeholder:"Телефон"},null,512),[[m,s.filters.phone]]),e[16]||(e[16]=t("label",{for:"phoneInput"},"Телефон",-1))]),t("div",Z,[a(t("input",{"onUpdate:modelValue":e[5]||(e[5]=r=>s.filters.email=r),class:"form-control",id:"emailInput",placeholder:"Email"},null,512),[[m,s.filters.email]]),e[17]||(e[17]=t("label",{for:"emailInput"},"Email",-1))]),t("div",ee,[a(t("input",{type:"number","onUpdate:modelValue":e[6]||(e[6]=r=>s.filters.percent=r),class:"form-control",id:"percentInput",placeholder:"Процент"},null,512),[[m,s.filters.percent]]),e[18]||(e[18]=t("label",{for:"percentInput"},"Процент",-1))]),t("div",te,[a(t("input",{type:"date","onUpdate:modelValue":e[7]||(e[7]=r=>s.filters.birthday=r),class:"form-control",id:"birthdayInput"},null,512),[[m,s.filters.birthday]]),e[19]||(e[19]=t("label",{for:"birthdayInput"},"Дата рождения",-1))]),e[20]||(e[20]=t("h6",{class:"mt-3"},"Отображаемые поля",-1)),(n(!0),d(y,null,w(s.sortableFields,(r,o)=>(n(),d("div",{key:o,class:"form-check form-switch mb-2"},[a(t("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":S=>s.field_visible[o]=S,id:`switch-${o}`},null,8,se),[[$,s.field_visible[o]]]),t("label",{class:"form-check-label",for:`switch-${o}`},h(r),9,ie)]))),128))]),e[22]||(e[22]=t("div",{class:"modal-footer"},[t("button",{type:"submit",class:"btn btn-primary w-100 p-3"},"Применить")],-1))],32)])])],64)}const oe=M(G,[["render",le]]),b="/bot-api/suppliers",_=D("suppliers",{state:()=>({items:[],loading:!1,error:null,sort:{field:"id",direction:"desc"},pagination:null}),getters:{byId:i=>e=>i.items.find(l=>l.id===e)},actions:{setFilters(i){this.filters=i},setSort(i,e){this.sort={field:i,direction:e}},async fetchFiltered(i=1,e=30){const l=new URLSearchParams;Object.entries(this.filters).forEach(([s,p])=>{p!=null&&p!==""&&l.append(s,String(p))}),l.append("sort_field",this.sort.field),l.append("sort_direction",this.sort.direction),l.append("page",String(i)),l.append("size",String(e));const{data:f}=await c(`${b}?${l.toString()}`,"GET");return this.items=f.data,this.pagination=f,!0},async fetchAll(){this.loading=!0,this.error=null;try{const{data:i}=await c(`${b}`,"GET");this.items=i}catch(i){this.error=(i==null?void 0:i.message)||"Failed to load suppliers"}finally{this.loading=!1}},async fetchAllByPage(i=1){const{data:e}=await c(`${b}?page=${i}`,"GET");this.items=e.data,this.pagination=e},async fetchByUrl(i){const{data:e}=await c(i,"GET");this.items=e.data,this.pagination=e},async fetchOne(i){try{const{data:e}=await c(`${b}/${i}`,"GET");return e}catch(e){throw this.error=(e==null?void 0:e.message)||"Failed to load supplier",e}},async fetchSupplierWithProducts(i=1){const{data:e}=await c(`${b}/with-products?page=${i}`,"GET");this.items=e.data,this.pagination=e},async loadMoreSupplierProducts(i,e){const{data:l}=await c(`/fetch-next-products/${i}/products?page=${e}`,"GET");this.items.find(s=>s.id===i).products.push(...l.data)},async create(i){const{data:e}=await c(`${b}`,"POST",i);return this.items.push(e),e},async removeAll(i){await c(`${b}/remove-all`,"POST",{ids:i}),i.forEach(e=>{this.items=this.items.filter(l=>l.id!==e)})},async update(i,e){const{data:l}=await c(`${b}/${i}`,"PUT",e),f=this.items.findIndex(s=>s.id===i);return f!==-1&&(this.items[f]=l),l},async remove(i){await c(`${b}/${i}`,"DELETE"),this.items=this.items.filter(e=>e.id!==i)}}}),re={name:"SupplierForm",props:{isSimple:{type:Boolean,default:!1},initialData:{type:Object,default:null}},data(){return{suppliersStore:_(),isEdit:!1,form:{name:"",description:"",address:"",phone:"",work_phone:"",percent:8,birthday:"",email:""}}},created(){this.initialData&&(this.form={...this.initialData},this.isEdit=!0)},methods:{submitForm(){(this.isEdit?this.suppliersStore.update(this.form.id,this.form):this.suppliersStore.create(this.form)).then(e=>{console.log("test",e),this.$emit("saved",e)})}}},ne={class:"form-floating mb-2"},de={class:"form-floating mb-2"},ae={class:"form-floating mb-2"},pe={class:"form-floating mb-2"},me={class:"form-floating mb-2"},ue={class:"form-floating mb-2"},fe={class:"form-floating mb-2"},ce={class:"form-floating mb-2"};function he(i,e,l,f,s,p){const r=A("mask");return n(),d("form",{onSubmit:e[8]||(e[8]=v((...o)=>p.submitForm&&p.submitForm(...o),["prevent"]))},[t("div",ne,[a(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>s.form.name=o),type:"text",class:"form-control",id:"name",placeholder:"Название",required:""},null,512),[[m,s.form.name]]),e[9]||(e[9]=t("label",{for:"name"},"Название",-1))]),t("div",de,[a(t("input",{"onUpdate:modelValue":e[1]||(e[1]=o=>s.form.phone=o),type:"text",class:"form-control",id:"phone",placeholder:"Телефон",required:""},null,512),[[m,s.form.phone],[r,"+7(###) ###-##-##"]]),e[10]||(e[10]=t("label",{for:"phone"},"Телефон",-1))]),l.isSimple?u("",!0):(n(),d(y,{key:0},[t("div",ae,[a(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=o=>s.form.description=o),class:"form-control",id:"description",placeholder:"Описание",style:{height:"100px"}},null,512),[[m,s.form.description]]),e[11]||(e[11]=t("label",{for:"description"},"Описание",-1))]),t("div",pe,[a(t("input",{"onUpdate:modelValue":e[3]||(e[3]=o=>s.form.address=o),type:"text",class:"form-control",id:"address",placeholder:"Адрес"},null,512),[[m,s.form.address]]),e[12]||(e[12]=t("label",{for:"address"},"Адрес",-1))]),t("div",me,[a(t("input",{"onUpdate:modelValue":e[4]||(e[4]=o=>s.form.work_phone=o),type:"text",class:"form-control",id:"work_phone",placeholder:"Телефон",required:""},null,512),[[m,s.form.work_phone],[r,"+7(###) ###-##-##"]]),e[13]||(e[13]=t("label",{for:"work_phone"},"Рабочий телефон",-1))]),t("div",ue,[a(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>s.form.percent=o),type:"number",step:"0.01",class:"form-control",id:"percent",placeholder:"Процент"},null,512),[[m,s.form.percent]]),e[14]||(e[14]=t("label",{for:"percent"},"Процент, %",-1))]),t("div",fe,[a(t("input",{"onUpdate:modelValue":e[6]||(e[6]=o=>s.form.birthday=o),type:"date",class:"form-control",id:"birthday",placeholder:"Дата рождения"},null,512),[[m,s.form.birthday]]),e[15]||(e[15]=t("label",{for:"birthday"},"Дата рождения",-1))]),t("div",ce,[a(t("input",{"onUpdate:modelValue":e[7]||(e[7]=o=>s.form.email=o),type:"email",class:"form-control",id:"email",placeholder:"Email"},null,512),[[m,s.form.email]]),e[16]||(e[16]=t("label",{for:"email"},"Email",-1))])],64)),e[17]||(e[17]=t("button",{type:"submit",class:"btn btn-primary w-100 p-3"},"Сохранить",-1))],32)}const I=M(re,[["render",he]]),be={class:"input-group mb-2"},ye={class:"form-floating"},Se={class:"form-check form-switch mb-2"},ve={class:"d-flex"},ge={class:"list-group"},ke=["onClick"],we=["onClick"],Fe={key:0,class:"badge bg-primary"},Ee={key:1,class:"badge bg-primary rounded-pill"},Ve={key:0,class:"mb-0"},Ue={key:1,class:"mb-0 fw-bold small"},Ce={key:2,class:"mb-2"},Ie={key:3,class:"mb-2"},$e={key:4,class:"mb-2"},Me={class:"dropdown flex-shrink-0"},_e={class:"dropdown-menu dropdown-menu-end"},De={key:0},Ae=["onClick"],Be=["onClick"],Te=["onClick"],Pe={key:2,class:"alert alert-info mt-3"},Ge={class:"modal fade",id:"editSupplierModal",tabindex:"-1"},Ne={class:"modal-dialog"},Oe={class:"modal-content"},je={class:"modal-body"},ze={name:"SupplierListGroup",props:["forSelect"],data(){return{field_visible:null,modalStore:P(),selection:[],search:null,showSimpleSupplierForm:!1,selectedSupplier:null,suppliersStore:_()}},computed:{},created(){this.fetchData()},methods:{findSupplier(){this.suppliersStore.setFilters({name:this.search||""}),this.suppliersStore.setSort("id","asc"),this.suppliersStore.fetchFiltered(0,30)},addNewSupplier(i){this.$emit("select",i)},applyFilters(i){this.field_visible=i.field_visible;let e=i.size||30,l=i.page||0;delete i.field_visible,this.suppliersStore.setFilters(i.filters),this.suppliersStore.setSort(i.sort.field,i.sort.direction),this.suppliersStore.fetchFiltered(l,e)},removeAll(){this.modalStore.open("Вы уверены, что хотите удалить все выбранные элементы?",()=>{this.suppliersStore.removeAll(this.selection),this.selection=[]},()=>{this.modalStore.close(),this.selection=[]})},openEditModal(i){this.selectedSupplier=null,this.$nextTick(()=>{this.selectedSupplier=i,new bootstrap.Modal(document.getElementById("editSupplierModal")).show()})},toggleSelection(i){let e=this.selection.findIndex(l=>l===i);e===-1?this.selection.push(i):this.selection.splice(e,1)},selectAll(){this.selection.length===0?this.suppliersStore.items.forEach(i=>{this.selection.indexOf(i.id)===-1&&this.selection.push(i.id)}):this.selection=[]},async fetchData(i=0){await this.suppliersStore.fetchAllByPage(i)},async fetchDataByUrl(i){await this.suppliersStore.fetchByUrl(i)},selectSupplier(i){this.forSelect&&this.$emit("select",i)},openDeleteModal(i){this.selectedSupplier=i,this.modalStore.open(`Вы уверены, что хотите удалить ${this.selectedSupplier.name}?`,()=>{this.suppliersStore.remove(this.selectedSupplier.id),this.selection=[],this.fetchData()},()=>{this.modalStore.close(),this.selection=[]})}}},We=Object.assign(ze,{setup(i){return(e,l)=>{var f;return n(),d(y,null,[t("div",be,[t("div",ye,[a(t("input",{class:"form-control",type:"search",onKeyup:l[0]||(l[0]=(...s)=>e.findSupplier&&e.findSupplier(...s)),"onUpdate:modelValue":l[1]||(l[1]=s=>e.search=s),id:"supplierInput",placeholder:"Поставщик"},null,544),[[m,e.search]]),l[6]||(l[6]=t("label",{for:"supplierInput"},"Поставщик",-1))]),t("button",{onClick:l[2]||(l[2]=(...s)=>e.findSupplier&&e.findSupplier(...s)),type:"button",class:"btn btn-outline-light text-primary"}," Найти ")]),t("div",Se,[a(t("input",{class:"form-check-input",type:"checkbox","onUpdate:modelValue":l[3]||(l[3]=s=>e.showSimpleSupplierForm=s),id:"show-simple-supplier-form"},null,512),[[$,e.showSimpleSupplierForm]]),l[7]||(l[7]=t("label",{class:"form-check-label",for:"show-simple-supplier-form"}," Добавить и выбрать нового поставщика ",-1))]),e.showSimpleSupplierForm?(n(),U(I,{key:0,onSaved:e.addNewSupplier,class:"mb-2","is-simple":!0},null,8,["onSaved"])):u("",!0),i.forSelect?u("",!0):(n(),d(y,{key:1},[C(oe,{onApplyFilters:e.applyFilters},null,8,["onApplyFilters"]),t("div",ve,[t("a",{href:"javascript:void(0)",onClick:l[4]||(l[4]=(...s)=>e.selectAll&&e.selectAll(...s)),class:"small"},"Выделить все"),e.selection.length>0?(n(),d("a",{key:0,href:"javascript:void(0)",onClick:l[5]||(l[5]=(...s)=>e.removeAll&&e.removeAll(...s)),class:"small text-danger mx-2"},"Удалить выделенное")):u("",!0)])],64)),t("ul",ge,[(n(!0),d(y,null,w(e.suppliersStore.items,s=>{var p,r,o,S,F,E,V;return n(),d("li",{key:s.id,class:B(["list-group-item d-flex justify-content-between align-items-start",{"border-primary":e.selection.indexOf(s.id)!==-1}])},[t("div",{class:"flex-grow-1 me-3 text-break",onClick:g=>e.selectSupplier(s)},[t("div",{class:"fw-bold",onClick:g=>e.toggleSelection(s.id)},[(p=e.field_visible)!=null&&p.id?(n(),d("span",Fe,"#"+h(s.id),1)):u("",!0),k(h(s.name)+" ",1),(r=e.field_visible)!=null&&r.percent?(n(),d("span",Ee,h(s.percent)+"%",1)):u("",!0)],8,we),((o=e.field_visible)!=null&&o.description,n(),d("p",Ve,h(s.description||"-"),1)),((S=e.field_visible)!=null&&S.phone,n(),d("p",Ue,h(s.phone),1)),(F=e.field_visible)!=null&&F.email?(n(),d("p",Ce,h(s.email),1)):u("",!0),(E=e.field_visible)!=null&&E.address?(n(),d("p",Ie,h(s.address),1)):u("",!0),(V=e.field_visible)!=null&&V.birthday?(n(),d("p",$e,h(s.birthday),1)):u("",!0)],8,ke),t("div",Me,[l[8]||(l[8]=t("button",{class:"btn btn-sm",type:"button","data-bs-toggle":"dropdown"},[t("i",{class:"fas fa-bars"})],-1)),t("ul",_e,[i.forSelect?(n(),d("li",De,[t("a",{class:"dropdown-item",href:"#",onClick:v(g=>e.selectSupplier(s),["prevent"])},"Выбрать",8,Ae)])):(n(),d(y,{key:1},[t("li",null,[t("a",{class:"dropdown-item",href:"#",onClick:v(g=>e.openEditModal(s),["prevent"])},"Редактировать",8,Be)]),t("li",null,[t("a",{class:"dropdown-item text-danger",href:"#",onClick:v(g=>e.openDeleteModal(s),["prevent"])},"Удалить",8,Te)])],64))])])],2)}),128))]),C(T,{pagination:e.suppliersStore.pagination,onPageChanged:e.fetchDataByUrl},null,8,["pagination","onPageChanged"]),((f=e.suppliersStore.items)==null?void 0:f.length)===0?(n(),d("div",Pe," Поставщиков пока нет. ")):u("",!0),t("div",Ge,[t("div",Ne,[t("div",Oe,[l[9]||(l[9]=t("div",{class:"modal-header"},[t("h5",{class:"modal-title"},"Редактирование категории"),t("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),t("div",je,[e.selectedSupplier?(n(),U(I,{key:0,"initial-data":e.selectedSupplier,onSaved:e.fetchData},null,8,["initial-data","onSaved"])):u("",!0)])])])])],64)}}});export{I as S,We as _,_ as u};
