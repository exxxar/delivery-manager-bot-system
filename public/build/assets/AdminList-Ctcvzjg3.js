import{f as S,H as k,c as l,o as i,b as e,w as p,v as y,J as w,h as c,d as u,e as r,F as f,r as _,i as A,t as m,k as R}from"./app-DclKkqI6.js";import{U as D}from"./UserForm-BUTQgqfg.js";import{P as U}from"./Pagination-DuyVbnSZ.js";import{m as h}from"./makeAxiosFactory-DL7bdn3R.js";import{_ as C}from"./_plugin-vue_export-helper-DlAUqK2U.js";import{u as M}from"./users-B0m2_QXu.js";const b="/bot-api/admins",v=S("admins",{state:()=>({items:[],loading:!1,error:null}),getters:{byId:o=>t=>o.items.find(a=>a.id===t)},actions:{async fetchAdminsByPage(o=1){const{data:t}=await h(`${b}?page=${o}`,"GET");this.items=t.data,this.pagination=t},async fetchByUrl(o){const{data:t}=await h(o,"GET");this.items=t.data,this.pagination=t},async downloadPersonalAdminReport(o){var a,s;const t=k();t.show("Подготавливаем отчет"),this.loading=!0,this.error=null;try{const{data:n}=await h(`${b}/download-personal-report`,"POST",o);return t.show("Отчет отправлен","success"),n}catch(n){throw this.error=((s=(a=n.response)==null?void 0:a.data)==null?void 0:s.message)??"Ошибка отправки отчёта",t.show(this.error,"error"),n}finally{this.loading=!1}},async downloadReport(o){var t,a;this.loading=!0,this.error=null;try{const{data:s}=await h(`${b}/download-report`,"POST",o);return s}catch(s){throw this.error=((a=(t=s.response)==null?void 0:t.data)==null?void 0:a.message)??"Ошибка отправки отчёта",s}finally{this.loading=!1}}}}),B={name:"ReportGenerator",props:["type","isSimple"],data(){return{need_more_options:!1,adminsStore:v(),report:{result_type:0,startDate:"",endDate:"",type:this.type||"",restriction:null}}},methods:{generateReport(){const o={...this.report};this.$emit("generate-report",o)}}},$={class:"form-floating mb-2"},P={class:"form-floating mb-2"},E={class:"form-floating mb-2"},V=["disabled"];function I(o,t,a,s,n,g){return i(),l("form",{onSubmit:t[3]||(t[3]=c((...d)=>g.generateReport&&g.generateReport(...d),["prevent"]))},[e("div",$,[p(e("input",{type:"date",class:"form-control",id:"startDate","onUpdate:modelValue":t[0]||(t[0]=d=>n.report.startDate=d),required:""},null,512),[[y,n.report.startDate]]),t[4]||(t[4]=e("label",{for:"startDate"},"Дата начала периода",-1))]),e("div",P,[p(e("input",{type:"date",class:"form-control",id:"endDate","onUpdate:modelValue":t[1]||(t[1]=d=>n.report.endDate=d),required:""},null,512),[[y,n.report.endDate]]),t[5]||(t[5]=e("label",{for:"endDate"},"Дата окончания периода",-1))]),e("div",E,[p(e("select",{"onUpdate:modelValue":t[2]||(t[2]=d=>n.report.result_type=d),class:"form-select",id:"floatingSelect","aria-label":"Floating label select example"},[...t[6]||(t[6]=[e("option",{value:"0"},"Классический отчет",-1),e("option",{value:"1"},"Расширенный отчет",-1)])],512),[[w,n.report.result_type]]),t[7]||(t[7]=e("label",{for:"floatingSelect"},"Как вывести результат",-1))]),e("button",{disabled:n.adminsStore.loading,type:"submit",class:"btn btn-primary p-3 w-100"}," Сформировать отчёт ",8,V)],32)}const G=C(B,[["render",I]]),T={class:"list-group"},F=["onClick"],j={class:"badge bg-primary"},q={class:"text-muted mb-0 small"},N={class:"text-muted mb-2 small"},O={class:"form-check form-switch"},W=["onChange","onUpdate:modelValue","id"],L=["for"],H={class:"dropdown"},J={class:"dropdown-menu dropdown-menu-end"},z={key:0},K=["onClick"],Q=["onClick"],X=["onClick"],Y=["onClick"],Z={key:1,class:"alert alert-info mt-3"},x={class:"modal fade",id:"reportModal",tabindex:"-1"},ee={class:"modal-dialog"},te={class:"modal-content"},oe={class:"modal-body"},se={class:"modal fade",id:"roleSwitcherUserModal",tabindex:"-1"},ae={class:"modal-dialog modal-lg"},ne={class:"modal-content"},ie={class:"modal-body"},le={class:"form-floating mb-2"},de={class:"modal fade",id:"editUserModal",tabindex:"-1"},re={class:"modal-dialog modal-lg"},me={class:"modal-content"},ce={class:"modal-body"},pe={name:"AdminList",props:["forSelect"],data(){return{adminsStore:v(),userStore:M(),selectedAdmin:null}},created(){this.fetchData()},methods:{selectAdmin(o){this.forSelect&&this.$emit("select",o)},openRoleSwitcher(o){this.selectedAdmin=o,new bootstrap.Modal(document.getElementById("roleSwitcherUserModal")).show()},openEdit(o){this.selectedAdmin=o,new bootstrap.Modal(document.getElementById("editUserModal")).show()},async changeAdminWorkStatus(o){await this.userStore.updateWorkStatus(o.id,o.is_work)},async handleReport(o){o.user_id=this.selectedAdmin.id,await this.adminsStore.downloadPersonalAdminReport(o)},async fetchData(o=1){await this.adminsStore.fetchAdminsByPage(o).then(()=>{const t=bootstrap.Modal.getInstance(document.getElementById("editUserModal"));t&&t.hide()})},async fetchDataByUrl(o){await this.adminsStore.fetchByUrl(o)},async downloadReport(o){await this.adminsStore.downloadReport(o)},async changeRole(){await this.userStore.updateRole(this.selectedAdmin.id,this.selectedAdmin.role).then(()=>{this.fetchData(),bootstrap.Modal.getInstance(document.getElementById("roleSwitcherUserModal")).hide()})}}},we=Object.assign(pe,{setup(o){return(t,a)=>(i(),l(f,null,[e("ul",T,[(i(!0),l(f,null,_(t.adminsStore.items,s=>(i(),l("li",{key:s.id,class:"list-group-item d-flex justify-content-between align-items-center"},[e("div",null,[e("div",{onClick:n=>t.selectAdmin(s),class:"fw-bold"},[e("span",j,m(s.percent)+"%",1),A(" "+m(s.name)+" ",1),e("p",q,m(s.phone||"Телефон не указан"),1),e("p",N,m(s.email),1)],8,F),e("div",O,[p(e("input",{onChange:n=>t.changeAdminWorkStatus(s),class:"form-check-input",type:"checkbox","onUpdate:modelValue":n=>s.is_work=n,id:`is-work-${s.id}`},null,40,W),[[R,s.is_work]]),e("label",{class:"form-check-label",for:`is-work-${s.id}`},m(s.is_work?"работает":"не работает"),9,L)])]),e("div",H,[a[2]||(a[2]=e("button",{class:"btn btn-sm",type:"button","data-bs-toggle":"dropdown"},[e("i",{class:"fas fa-bars"})],-1)),e("ul",J,[o.forSelect?(i(),l("li",z,[e("a",{class:"dropdown-item",href:"#",onClick:c(n=>t.selectAdmin(s),["prevent"])},"Выбрать",8,K)])):r("",!0),o.forSelect?r("",!0):(i(),l(f,{key:1},[e("li",null,[e("button",{type:"button",onClick:n=>t.selectedAdmin=s,class:"dropdown-item","data-bs-toggle":"modal","data-bs-target":"#reportModal"}," Сформировать отчет ",8,Q)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:c(n=>t.openRoleSwitcher(s),["prevent"])},"Сменить роль",8,X)]),e("li",null,[e("a",{class:"dropdown-item",href:"#",onClick:c(n=>t.openEdit(s),["prevent"])},"Редактировать",8,Y)])],64))])])]))),128))]),t.adminsStore.items.length>0?(i(),u(U,{key:0,pagination:t.adminsStore.pagination,onPageChanged:t.fetchDataByUrl},null,8,["pagination","onPageChanged"])):r("",!0),t.adminsStore.items.length===0?(i(),l("div",Z," Администраторов пока нет. ")):r("",!0),e("div",x,[e("div",ee,[e("div",te,[a[3]||(a[3]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title"},"Отчет по администратору"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),e("div",oe,[t.selectedAdmin?(i(),u(G,{key:0,type:"admins","is-simple":!0,"object-id":t.selectedAdmin.id,onGenerateReport:t.handleReport},null,8,["object-id","onGenerateReport"])):r("",!0)])])])]),e("div",se,[e("div",ae,[e("div",ne,[a[7]||(a[7]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title"},"Редактирование пользователя"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),e("div",ie,[t.selectedAdmin?(i(),l("form",{key:0,onSubmit:a[1]||(a[1]=c((...s)=>t.changeRole&&t.changeRole(...s),["prevent"]))},[e("div",le,[p(e("select",{"onUpdate:modelValue":a[0]||(a[0]=s=>t.selectedAdmin.role=s),class:"form-select",id:"role",required:""},[...a[4]||(a[4]=[e("option",{value:0},"Пользователь",-1),e("option",{value:1},"Администратор",-1),e("option",{value:2},"Поставщик",-1),e("option",{value:3},"Старший администратор",-1)])],512),[[w,t.selectedAdmin.role]]),a[5]||(a[5]=e("label",{for:"role"},"Роль",-1))]),a[6]||(a[6]=e("button",{type:"submit",class:"btn btn-primary w-100 p-3"}," Сохранить изменения ",-1))],32)):r("",!0)])])])]),e("div",de,[e("div",re,[e("div",me,[a[8]||(a[8]=e("div",{class:"modal-header"},[e("h5",{class:"modal-title"},"Редактирование администратора"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal"})],-1)),e("div",ce,[t.selectedAdmin?(i(),u(D,{key:0,initialData:t.selectedAdmin,onSaved:t.fetchData},null,8,["initialData","onSaved"])):r("",!0)])])])])],64))}});export{G as R,we as _};
